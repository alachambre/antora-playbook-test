<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How to customize the Bonita container using initialization scripts :: Bonita documentation</title>
    <link rel="canonical" href="https://alachambre.github.io/antora-playbook-test/bonita/7.12/bcd/3.4/custom_init">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css"
    />
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class="bonita-logo" href="https://alachambre.github.io/antora-playbook-test/bonita/7.12"></a>
      </div>

      <div class="navbar-item hide-for-print">
        <input type="text" placeholder="Search Docs" class="query ds-input" id="search-query">
      </div>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item-orphan is-hoverable">
          <a href="https://alachambre.github.io/antora-playbook-test/bonita/7.12/what-is-bonita" class="">Getting started</a>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item-orphan is-hoverable">
          <a href="https://community.bonitasoft.com/" class="">Community</a>
        </div>
      </div>

      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Bonita</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="../../bonita/7.12/">7.12</a>
            <a class="navbar-item" href="../../bonita/7.11/">7.11</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Bonita Continous Delivery</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="./">3.4</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Bonita REST API</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="../../bonitaAPI/7.12/">7.12</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="bcd" data-version="3.4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="./">Bonita Continous Delivery</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="release_notes">Release notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="requirements-and-compatibility">Requirements and compatibility</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting_started">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="upgrade_bcd">Upgrade BCD</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#_bcd_services_and_scenarios.adoc">BCD services and scenarios</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bcd_controller">Controller Docker image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bcd_cli">Command-line interface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scenarios">Scenario file reference</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#_howtos.adoc">Howtos</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#_manage_stack.adoc">Manage Bonita stacks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="aws_prerequisites">Configure Amazon Web Services (AWS) for BCD</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="aws_sso">Configure AWS single sign-on</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="aws_organizations">Assume IAM role within AWS Organizations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="azure-prerequisites">Configure Microsoft Azure for BCD</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy_with_static_inventory">Deploy with a static inventory</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-with-existing-database">Deploy with an existing database</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#_custom_init.adoc">Customize the Bonita container</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="4">
    <a class="nav-link" href="custom_init">Using initialization scripts</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="how_to_configure_rest_api_authorization">Configuring REST API authorization</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="how_to_enable_remote_monitoring_jmx">Enabling remote monitoring with JMX</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="manage_bonita_licenses">Manage Bonita licenses</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#_manage_living_application.adoc">Manage Bonita Living Applications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="livingapp_build">Build a Living App repository</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="livingapp_manage_configuration">Manage Living App configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="livingapp_deploy">Deploy Living App artifacts</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="livingapp_build_and_deploy">Build and deploy (Best Practices)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="how_to_use_bcd_with_data_encrypted">Use BCD with sensitive data encrypted</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jenkins_example">Integrate BCD with Jenkins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_guide">Troubleshooting guide</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Bonita Continous Delivery</span>
    <span class="version">3.4</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Bonita</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../bonita/7.12/">7.12</a>
        </li>
        <li class="version">
          <a href="../../bonita/7.11/">7.11</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Bonita Continous Delivery</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="./">3.4</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Bonita REST API</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../bonitaAPI/7.12/">7.12</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../bonita/7.12/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="./">Bonita Continous Delivery</a></li>
    <li><a href="#_howtos.adoc">Howtos</a></li>
    <li><a href="#_manage_stack.adoc">Manage Bonita stacks</a></li>
    <li><a href="#_custom_init.adoc">Customize the Bonita container</a></li>
    <li><a href="custom_init">Using initialization scripts</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/alachambre/antora-sources-test-2/edit/master/modules/ROOT/pages/custom_init.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">How to customize the Bonita container using initialization scripts</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Bonita Docker container deployed by BCD can be further customized thanks to a custom initialization mechanism.</p>
</div>
<div class="paragraph">
<p>This feature relies on the ability to extend the <a href="https://hub.docker.com/_/bonita/">Bonita Docker image</a> through custom <code>*.sh</code> shell scripts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_should_i_put_custom_initialization_scripts"><a class="anchor" href="#_where_should_i_put_custom_initialization_scripts"></a>Where should I put custom initialization scripts?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Custom initialization files can be <strong>static</strong> or they can be <strong>dynamic</strong> while relying on runtime variables.
Dynamic initialization files then leverage the <a href="http://docs.ansible.com/ansible/latest/playbooks_templating.html">Jinja2 templating framework used by Ansible</a>.</p>
</div>
<div class="sect2">
<h3 id="_static_initialization_files"><a class="anchor" href="#_static_initialization_files"></a>Static initialization files</h3>
<div class="paragraph">
<p>Static custom initialization files must be placed in BCD&#8217;s <code>roles/bonita/files/custom-init.d</code> folder.
All files from this folder will be uploaded to the target host regardless their extension.
However only the files with a <code>.sh</code> extension will be executed.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the directory layout for a <code>register-event-handler.sh</code> custom script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>roles
├── bonita
│   ├── files
│   │   ├── custom-init.d
│   │   │   ├── bonita-tenant-sp-custom.xml
│   │   │   ├── config-workers.sh
│   │   │   ├── event-handler-example-1.0.0-SNAPSHOT.jar
│   │   │   └── register-event-handler.sh</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_initialization_files"><a class="anchor" href="#_dynamic_initialization_files"></a>Dynamic initialization files</h3>
<div class="paragraph">
<p>Dynamic custom initialization files must be placed in BCD&#8217;s <code>roles/bonita/templates/custom-init.d</code> folder.
All files with a <code>.j2</code> extension will be uploaded to the target host and stripped from the <code>.j2</code> suffix.
However only the files with a <code>.sh.j2</code> extension will be executed.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the directory layout for the provided <code>config-cluster.sh.j2</code> initialization script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>roles
├── bonita
│   └── templates
│       └── custom-init.d
│           ├── bonita-platform-sp-cluster-custom.properties.j2
│           ├── config-cluster.sh.j2</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_when_are_custom_initialization_scripts_invoked"><a class="anchor" href="#_when_are_custom_initialization_scripts_invoked"></a>When are custom initialization scripts invoked?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Custom initialization scripts are invoked once the database has been initialized and the Tomcat server has been configured with <a href="https://documentation.bonitasoft.com/bonita/$7.12/BonitaBPM_platform_setup">Bonita Platform setup tool</a>.</p>
</div>
<div class="paragraph">
<p>Hence the Bonita Docker image startup sequence can be described as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Initialize database: <code>setup.sh init</code></p>
</li>
<li>
<p>Configure Tomcat server: <code>setup.sh configure</code></p>
</li>
<li>
<p>Execute custom initialization <code>*.sh</code> scripts found in the container&#8217;s <code>/opt/custom-init.d</code> folder</p>
</li>
<li>
<p>Start Tomcat server</p>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<p>info <strong>Warning</strong>: all custom scripts are re-executed each time the Bonita Docker container is restarted.</p>
</dd>
</dl>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you want your script to be executed only once, you need to handle the conditional execution in your custom script itself.
+ For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

indicator_path=/opt/$(basename $BASH_ARGV)-executed
if [ -f ${indicator_path} ]; then
  echo "Custom script already executed" &amp;&amp; return 0
fi

#
# Do some interesting stuff
# [...]

# Create indicator file
touch ${indicator_path}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<p>== In which order are custom initialization scripts invoked?</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Custom scripts are executed in natural sort order as implemented by the <code>ls</code> shell command.
It is also referred as <em>natural sort of (version) numbers within text</em>.</p>
</div>
<div class="paragraph">
<p>More precisely scripts are executed in the order returned by this command: <code>ls -v /opt/custom-init.d/*.sh</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples"><a class="anchor" href="#_examples"></a>Examples</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_config_workers_sh"><a class="anchor" href="#_1_config_workers_sh"></a>1. config-workers.sh</h3>
<div class="paragraph">
<p>The <code>config-workers.sh</code> script is provided as part of BCD&#8217;s core scripts.
+ In particular it shows how to further configure the server using <a href="https://documentation.bonitasoft.com/bonita/$7.12/BonitaBPM_platform_setup">Bonita Platform setup tool</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_config_cluster_sh_j2"><a class="anchor" href="#_2_config_cluster_sh_j2"></a>2. config-cluster.sh.j2</h3>
<div class="paragraph">
<p>The <code>config-cluster.sh.j2</code> script template is provided as part of BCD&#8217;s core scripts.
+ In particular it shows how to conditionally configure a cluster deployment on AWS using BCD variables and <a href="http://docs.ansible.com/ansible/latest/playbooks_templating.html">Jinja2 templating engine</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_3_register_event_handler_sh"><a class="anchor" href="#_3_register_event_handler_sh"></a>3. register-event-handler.sh</h3>
<div class="paragraph">
<p>This sample script deploys and registers a Bonita engine Event handler as described in <a href="https://documentation.bonitasoft.com/bonita/$7.12/event-handlers">Event handlers Documentation</a>.</p>
</div>
<div class="paragraph">
<p>Assuming the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>roles/bonita/files/custom-init.d/event-handler-example-1.0.0-SNAPSHOT.jar</code> (event handler JAR file)</p>
</li>
<li>
<p><code>roles/bonita/files/custom-init.d/bonita-tenant-sp-custom.xml</code> (tenant configuration file where the event handler is registered)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s a sample <code>register-event-handler.sh</code> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

set -euxo pipefail

indicator_path=/opt/$(basename $BASH_ARGV)-executed
if [ -f ${indicator_path} ]; then
  echo "Custom script already executed" &amp;&amp; return 0
fi

BONITA_PATH=${BONITA_PATH:-/opt/bonita}
BONITA_FILES=${BONITA_FILES:-/opt/files}
BONITA_SETUP_SH="${BONITA_PATH}/Bonita*Subscription-${BONITA_VERSION}-*omcat*/setup/setup.sh"

EVENT_HANDLER_FILENAME=event-handler-example-1.0.0-SNAPSHOT.jar


war_path=$(find "${BONITA_PATH}/Bonita"*"Subscription-${BONITA_VERSION}-"*"omcat"*"/server/webapps" -name bonita.war)
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &amp;&amp; pwd)"
workdir="${BONITA_FILES}/register-event-handler"
rm -rf ${workdir} &amp;&amp; mkdir -p ${workdir}

pushd ${workdir}

# copy event handler jar
mkdir -p WEB-INF/lib
cp ${script_dir}/${EVENT_HANDLER_FILENAME} WEB-INF/lib/

# repackage war
zip -r "${war_path}" "WEB-INF/lib/${EVENT_HANDLER_FILENAME}"


# register event handler
${BONITA_SETUP_SH} pull
cp /opt/custom-init.d/bonita-tenant-sp-custom.xml ${BONITA_PATH}/Bonita*Subscription-${BONITA_VERSION}-*omcat*/setup/platform_conf/current/tenant_template_engine/
${BONITA_SETUP_SH} push

# Create indicator file
touch ${indicator_path}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_deploy_probe_sh"><a class="anchor" href="#_4_deploy_probe_sh"></a>4. deploy-probe.sh</h3>
<div class="paragraph">
<p>This sample script deploys <a href="https://github.com/psi-probe/psi-probe/wiki">PSI Probe</a> (an <em>Advanced manager and monitor for Apache Tomcat</em>) along with Bonita in the Tomcat bundle.</p>
</div>
<div class="paragraph">
<p>In particular, it shows how to reference BCD variables in custom initialization files.
All custom referenced variables can be defined at <a href="scenarios" class="page">BCD scenario</a> level.</p>
</div>
<div class="paragraph">
<p>With this example, PSI Probe will be available at this URL: <code><a href="http://&lt;bonita_host&gt;:8081/probe" class="bare">http://&lt;bonita_host&gt;:8081/probe</a></code>.
To connect to PSI Probe, use the credentials defined with the <code>custom_manager_username</code> and <code>custom_manager_password</code> variables.
By default: <code>custom_manager_username=admin</code> and <code>custom_manager_password=t0psecret</code>.</p>
</div>
<div class="sect3">
<h4 id="_deploy_probe_sh_j2"><a class="anchor" href="#_deploy_probe_sh_j2"></a>deploy-probe.sh.j2</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

set -euxo pipefail

indicator_path=/opt/$(basename $BASH_ARGV)-executed
if [ -f ${indicator_path} ]; then
  echo "Custom script already executed" &amp;&amp; return 0
fi


BONITA_PATH=${BONITA_PATH:-/opt/bonita}
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &amp;&amp; pwd)"

pushd ${BONITA_PATH}/Bonita*Subscription-${BONITA_VERSION}-*omcat*

# Allow Tomcat Manager from different host
cp ${script_dir}/manager-context.xml server/conf/Catalina/localhost/manager.xml

# PSI Probe
curl -sSL -o server/webapps/probe.war https://github.com/psi-probe/psi-probe/releases/download/{{ custom_psi_probe_version | default('3.0.0.RC2') }}/probe.war
cp ${script_dir}/tomcat-users.xml server/conf/tomcat-users.xml

# Create indicator file
touch ${indicator_path}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manager_context_xml_j2"><a class="anchor" href="#_manager_context_xml_j2"></a>manager-context.xml.j2</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Context antiResourceLocking="false" privileged="true" &gt;
  &lt;Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="{{ custom_manager_allow_pattern | default('^.*$') }}" /&gt;
  &lt;Manager sessionAttributeValueClassNameFilter="java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap"/&gt;
&lt;/Context&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tomcat_users_xml_j2"><a class="anchor" href="#_tomcat_users_xml_j2"></a>tomcat-users.xml.j2</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;tomcat-users xmlns="http://tomcat.apache.org/xml"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
              version="1.0"&gt;

  &lt;role rolename="probeuser" /&gt;
  &lt;role rolename="poweruser" /&gt;
  &lt;role rolename="poweruserplus" /&gt;

  &lt;role rolename="manager-gui" /&gt;

  &lt;user username="{{ custom_manager_username | default('admin') }}" password="{{ custom_manager_password | default('t0psecret') }}" roles="manager-gui" /&gt;

&lt;/tomcat-users&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_more_examples_about_rest_api_authorization"><a class="anchor" href="#_5_more_examples_about_rest_api_authorization"></a>5. More examples about REST API authorization</h3>
<div class="paragraph">
<p>See <a href="how_to_configure_rest_api_authorization" class="page">how to configure REST API authorization</a>.</p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>

<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    // Your apiKey and indexName will be given to you once
    // we create your config
    apiKey: '8b16fe941025bb59db192dce337bc486',
    indexName: 'test_BONITA',
    appId: 'LMVLEZKT54', // Should be only included if you are running DocSearch on your own.
    // Replace inputSelector with a CSS selector
    // matching your search input
    inputSelector: '#search-query',
    // Set debug to true to inspect the dropdown
    debug: false,
    algoliaOptions: {
      'facetFilters': ["tags:3.4", "tags:bcd"]
    },
  });
</script>
  </body>
</html>
